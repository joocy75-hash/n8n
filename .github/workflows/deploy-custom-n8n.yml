name: Build and Deploy Custom n8n

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@10.22.0

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build n8n
        run: pnpm build:n8n

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/images/n8n/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy docker-compose.production.yml to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          source: 'docker-compose.production.yml'
          target: '/root/group_e/'

      - name: Execute deployment script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            cd /root/group_e/

            # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            echo "N8N_AI_ANTHROPIC_KEY=${{ secrets.N8N_AI_ANTHROPIC_KEY }}" > .env

            # API í‚¤ ì„¤ì • í™•ì¸ (ë§ˆìŠ¤í‚¹ëœ ì¶œë ¥)
            if [ -z "${{ secrets.N8N_AI_ANTHROPIC_KEY }}" ]; then
              echo "âš ï¸ WARNING: N8N_AI_ANTHROPIC_KEY is not set!"
            else
              echo "âœ… N8N_AI_ANTHROPIC_KEY is configured (length: ${#N8N_AI_ANTHROPIC_KEY})"
            fi

            # Anthropic API ì—°ê²° í…ŒìŠ¤íŠ¸ (DNS í•´ì„ í™•ì¸)
            echo "ðŸ” Testing network connectivity to Anthropic API..."
            if curl -sI --connect-timeout 10 https://api.anthropic.com > /dev/null 2>&1; then
              echo "âœ… Network connectivity to api.anthropic.com: OK"
            else
              echo "âš ï¸ WARNING: Cannot reach api.anthropic.com - checking DNS..."
              nslookup api.anthropic.com || echo "DNS lookup failed"
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë¡œê·¸ ì €ìž¥ (ë””ë²„ê¹…ìš©)
            docker logs groupe-n8n --tail 50 2>/dev/null || echo "No existing container logs"

            # ë°°í¬ ì‹¤í–‰
            echo "ðŸš€ Pulling latest image..."
            docker compose -f docker-compose.production.yml pull

            echo "ðŸ”„ Recreating container..."
            docker compose -f docker-compose.production.yml up -d --force-recreate

            # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸° ë° ìƒíƒœ í™•ì¸
            echo "â³ Waiting for container to start..."
            sleep 10

            echo "ðŸ“Š Container status:"
            docker ps | grep groupe-n8n

            echo "ðŸ“œ Recent container logs:"
            docker logs groupe-n8n --tail 30 2>&1
