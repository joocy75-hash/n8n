name: Build and Deploy Custom n8n

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@10.22.0

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build n8n
        run: pnpm build:n8n

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/images/n8n/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy docker-compose.production.yml to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          source: 'docker-compose.production.yml'
          target: '/root/group_e/'

      - name: Execute deployment script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            set -e
            cd /root/group_e/

            echo "=========================================="
            echo "ðŸš€ n8n AI Workflow Builder Deployment"
            echo "=========================================="

            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            echo "ðŸ“ Creating .env file..."
            cat > .env << 'EOF'
            N8N_AI_ANTHROPIC_KEY=${{ secrets.N8N_AI_ANTHROPIC_KEY }}
            EOF

            # API í‚¤ ì„¤ì • í™•ì¸ (ë§ˆìŠ¤í‚¹ëœ ì¶œë ¥)
            echo ""
            echo "ðŸ”‘ Checking API Key configuration..."
            API_KEY="${{ secrets.N8N_AI_ANTHROPIC_KEY }}"
            if [ -z "$API_KEY" ]; then
              echo "âŒ ERROR: N8N_AI_ANTHROPIC_KEY is NOT set in GitHub Secrets!"
              echo "   Please add the Anthropic API key in repository Settings > Secrets > Actions"
              exit 1
            else
              KEY_LENGTH=${#API_KEY}
              KEY_PREFIX="${API_KEY:0:10}"
              echo "âœ… N8N_AI_ANTHROPIC_KEY is configured"
              echo "   - Length: $KEY_LENGTH characters"
              echo "   - Prefix: ${KEY_PREFIX}..."
            fi

            # .env íŒŒì¼ ê²€ì¦
            echo ""
            echo "ðŸ“‹ Verifying .env file..."
            if grep -q "N8N_AI_ANTHROPIC_KEY=sk-" .env 2>/dev/null; then
              echo "âœ… .env file contains valid API key format"
            else
              echo "âš ï¸ WARNING: .env file may not contain a valid Anthropic API key"
              echo "   Expected format: sk-ant-api03-..."
            fi

            # í˜¸ìŠ¤íŠ¸ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
            echo ""
            echo "ðŸŒ Testing network connectivity from HOST..."

            # DNS í•´ì„ í…ŒìŠ¤íŠ¸
            echo "   - DNS resolution test:"
            if nslookup api.anthropic.com > /dev/null 2>&1; then
              RESOLVED_IP=$(nslookup api.anthropic.com | grep -A1 'Name:' | grep 'Address:' | head -1 | awk '{print $2}')
              echo "     âœ… api.anthropic.com resolves to: $RESOLVED_IP"
            else
              echo "     âŒ DNS resolution failed for api.anthropic.com"
            fi

            # HTTPS ì—°ê²° í…ŒìŠ¤íŠ¸
            echo "   - HTTPS connection test:"
            if curl -sI --connect-timeout 10 https://api.anthropic.com 2>/dev/null | head -1; then
              echo "     âœ… HTTPS connection to api.anthropic.com: OK"
            else
              echo "     âŒ Cannot establish HTTPS connection to api.anthropic.com"
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë³´ ì €ìž¥
            echo ""
            echo "ðŸ“¦ Checking existing container..."
            if docker ps -a | grep -q groupe-n8n; then
              echo "   Existing container found, saving logs..."
              docker logs groupe-n8n --tail 20 2>&1 | head -20 || true
            else
              echo "   No existing container found"
            fi

            # ë°°í¬ ì‹¤í–‰
            echo ""
            echo "ðŸš€ Pulling latest image..."
            docker compose -f docker-compose.production.yml pull

            echo ""
            echo "ðŸ”„ Recreating container..."
            docker compose -f docker-compose.production.yml up -d --force-recreate

            # ì»¨í…Œì´ë„ˆ ì‹œìž‘ ëŒ€ê¸°
            echo ""
            echo "â³ Waiting for container to start (15 seconds)..."
            sleep 15

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo ""
            echo "ðŸ“Š Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|groupe-n8n"

            # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í™˜ê²½ë³€ìˆ˜ ê²€ì¦
            echo ""
            echo "ðŸ” Verifying container environment variables..."
            CONTAINER_API_KEY=$(docker exec groupe-n8n printenv N8N_AI_ANTHROPIC_KEY 2>/dev/null || echo "")
            if [ -n "$CONTAINER_API_KEY" ]; then
              CONTAINER_KEY_LENGTH=${#CONTAINER_API_KEY}
              echo "   âœ… N8N_AI_ANTHROPIC_KEY is set in container (length: $CONTAINER_KEY_LENGTH)"
            else
              echo "   âŒ N8N_AI_ANTHROPIC_KEY is NOT set in container!"
            fi

            docker exec groupe-n8n printenv | grep -E "^N8N_AI|^NODE_OPTIONS" | sed 's/=.*/=***/' || true

            # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸
            echo ""
            echo "ðŸŒ Testing network connectivity from CONTAINER..."

            # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ DNS í…ŒìŠ¤íŠ¸
            echo "   - Container DNS resolution:"
            if docker exec groupe-n8n nslookup api.anthropic.com > /dev/null 2>&1; then
              echo "     âœ… Container can resolve api.anthropic.com"
            else
              echo "     âš ï¸ Container DNS resolution may have issues"
            fi

            # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ HTTPS ì—°ê²° í…ŒìŠ¤íŠ¸
            echo "   - Container HTTPS connection:"
            if docker exec groupe-n8n curl -sI --connect-timeout 10 https://api.anthropic.com 2>/dev/null | head -1; then
              echo "     âœ… Container can connect to api.anthropic.com"
            else
              echo "     âŒ Container cannot connect to api.anthropic.com"
            fi

            # ìµœê·¼ ì»¨í…Œì´ë„ˆ ë¡œê·¸
            echo ""
            echo "ðŸ“œ Recent container logs:"
            echo "----------------------------------------"
            docker logs groupe-n8n --tail 30 2>&1

            echo ""
            echo "=========================================="
            echo "âœ… Deployment completed!"
            echo "=========================================="
