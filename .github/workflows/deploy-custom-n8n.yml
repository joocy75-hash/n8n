name: Build and Deploy Custom n8n

on:
  push:
    branches:
      - master

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@10.22.0

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build n8n
        run: pnpm build:n8n

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/images/n8n/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Copy deployment files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          source: 'docker-compose.production.yml,nginx/'
          target: '/root/group_e/'

      - name: Execute deployment script on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            set -e
            cd /root/group_e/

            echo "=========================================="
            echo "üöÄ n8n AI Workflow Builder Deployment"
            echo "=========================================="

            # ÌôòÍ≤ΩÎ≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
            echo "üìù Creating .env file..."
            cat > .env << 'EOF'
            N8N_AI_ANTHROPIC_KEY=${{ secrets.N8N_AI_ANTHROPIC_KEY }}
            EOF

            # API ÌÇ§ ÏÑ§Ï†ï ÌôïÏù∏ (ÎßàÏä§ÌÇπÎêú Ï∂úÎ†•)
            echo ""
            echo "üîë Checking API Key configuration..."
            API_KEY="${{ secrets.N8N_AI_ANTHROPIC_KEY }}"
            if [ -z "$API_KEY" ]; then
              echo "‚ùå ERROR: N8N_AI_ANTHROPIC_KEY is NOT set in GitHub Secrets!"
              echo "   Please add the Anthropic API key in repository Settings > Secrets > Actions"
              exit 1
            else
              KEY_LENGTH=${#API_KEY}
              KEY_PREFIX="${API_KEY:0:10}"
              echo "‚úÖ N8N_AI_ANTHROPIC_KEY is configured"
              echo "   - Length: $KEY_LENGTH characters"
              echo "   - Prefix: ${KEY_PREFIX}..."
            fi

            # .env ÌååÏùº Í≤ÄÏ¶ù
            echo ""
            echo "üìã Verifying .env file..."
            if grep -q "N8N_AI_ANTHROPIC_KEY=sk-" .env 2>/dev/null; then
              echo "‚úÖ .env file contains valid API key format"
            else
              echo "‚ö†Ô∏è WARNING: .env file may not contain a valid Anthropic API key"
              echo "   Expected format: sk-ant-api03-..."
            fi

            # Ìò∏Ïä§Ìä∏ÏóêÏÑú ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            echo ""
            echo "üåê Testing network connectivity from HOST..."

            # DNS Ìï¥ÏÑù ÌÖåÏä§Ìä∏
            echo "   - DNS resolution test:"
            if nslookup api.anthropic.com > /dev/null 2>&1; then
              RESOLVED_IP=$(nslookup api.anthropic.com | grep -A1 'Name:' | grep 'Address:' | head -1 | awk '{print $2}')
              echo "     ‚úÖ api.anthropic.com resolves to: $RESOLVED_IP"
            else
              echo "     ‚ùå DNS resolution failed for api.anthropic.com"
            fi

            # HTTPS Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            echo "   - HTTPS connection test:"
            if curl -sI --connect-timeout 10 https://api.anthropic.com 2>/dev/null | head -1; then
              echo "     ‚úÖ HTTPS connection to api.anthropic.com: OK"
            else
              echo "     ‚ùå Cannot establish HTTPS connection to api.anthropic.com"
            fi

            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ≥¥ Ï†ÄÏû•
            echo ""
            echo "üì¶ Checking existing container..."
            if docker ps -a | grep -q groupe-n8n; then
              echo "   Existing container found, saving logs..."
              docker logs groupe-n8n --tail 20 2>&1 | head -20 || true
            else
              echo "   No existing container found"
            fi

            # Î∞∞Ìè¨ Ïã§Ìñâ
            echo ""
            echo "üöÄ Pulling latest image..."
            docker compose -f docker-compose.production.yml pull

            echo ""
            echo "üîÑ Recreating container..."
            docker compose -f docker-compose.production.yml up -d --force-recreate

            # Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë ÎåÄÍ∏∞
            echo ""
            echo "‚è≥ Waiting for container to start (15 seconds)..."
            sleep 15

            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            echo ""
            echo "üìä Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|groupe-n8n"

            # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä ÌôòÍ≤ΩÎ≥ÄÏàò Í≤ÄÏ¶ù
            echo ""
            echo "üîç Verifying container environment variables..."
            CONTAINER_API_KEY=$(docker exec groupe-n8n printenv N8N_AI_ANTHROPIC_KEY 2>/dev/null || echo "")
            if [ -n "$CONTAINER_API_KEY" ]; then
              CONTAINER_KEY_LENGTH=${#CONTAINER_API_KEY}
              echo "   ‚úÖ N8N_AI_ANTHROPIC_KEY is set in container (length: $CONTAINER_KEY_LENGTH)"
            else
              echo "   ‚ùå N8N_AI_ANTHROPIC_KEY is NOT set in container!"
            fi

            docker exec groupe-n8n printenv | grep -E "^N8N_AI|^NODE_OPTIONS" | sed 's/=.*/=***/' || true

            # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂ÄÏóêÏÑú ÎÑ§Ìä∏ÏõåÌÅ¨ ÌÖåÏä§Ìä∏
            echo ""
            echo "üåê Testing network connectivity from CONTAINER..."

            # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä DNS ÌÖåÏä§Ìä∏
            echo "   - Container DNS resolution:"
            if docker exec groupe-n8n nslookup api.anthropic.com > /dev/null 2>&1; then
              echo "     ‚úÖ Container can resolve api.anthropic.com"
            else
              echo "     ‚ö†Ô∏è Container DNS resolution may have issues"
            fi

            # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä HTTPS Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            echo "   - Container HTTPS connection:"
            if docker exec groupe-n8n curl -sI --connect-timeout 10 https://api.anthropic.com 2>/dev/null | head -1; then
              echo "     ‚úÖ Container can connect to api.anthropic.com"
            else
              echo "     ‚ùå Container cannot connect to api.anthropic.com"
            fi

            # ÏµúÍ∑º Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏
            echo ""
            echo "üìú Recent container logs:"
            echo "----------------------------------------"
            docker logs groupe-n8n --tail 30 2>&1

            # Nginx ÏÑ§Ï†ï Ï†ÅÏö©
            echo ""
            echo "üåê Configuring Nginx reverse proxy..."

            # nginx ÏÑ§Ï†ï ÌååÏùº Î≥µÏÇ¨
            if [ -f "/root/group_e/nginx/ai-n8n.shop.conf" ]; then
              sudo cp /root/group_e/nginx/ai-n8n.shop.conf /etc/nginx/sites-available/ai-n8n.shop

              # Ïã¨Î≥ºÎ¶≠ ÎßÅÌÅ¨ ÏÉùÏÑ± (Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞)
              sudo ln -sf /etc/nginx/sites-available/ai-n8n.shop /etc/nginx/sites-enabled/ai-n8n.shop

              # nginx ÏÑ§Ï†ï ÌÖåÏä§Ìä∏
              if sudo nginx -t 2>&1; then
                echo "   ‚úÖ Nginx configuration is valid"
                sudo systemctl reload nginx
                echo "   ‚úÖ Nginx reloaded successfully"
              else
                echo "   ‚ùå Nginx configuration test failed"
              fi
            else
              echo "   ‚ö†Ô∏è Nginx config file not found, skipping..."
            fi

            # ÎèÑÎ©îÏù∏ Ï†ëÏÜç ÌÖåÏä§Ìä∏
            echo ""
            echo "üîó Testing domain access..."
            sleep 3
            if curl -sI --connect-timeout 10 http://ai-n8n.shop 2>/dev/null | head -1 | grep -q "200\|302"; then
              echo "   ‚úÖ http://ai-n8n.shop is accessible!"
            else
              echo "   ‚ö†Ô∏è Domain may not be accessible yet (DNS propagation may take time)"
            fi

            echo ""
            echo "=========================================="
            echo "‚úÖ Deployment completed!"
            echo "üåê Access: http://ai-n8n.shop"
            echo "=========================================="
